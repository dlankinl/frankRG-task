<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web file system</title>
    <style>
        /* Styles for the modal dialog */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #f4f4f4;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 40%;
        }
    </style>
</head>
<body>
<h1>Web file system for Frank RG</h1>
<button id="inputDialogBtn1">Create file</button>
<button id="inputDialogBtn2">Create directory</button>

<form id="uploadForm" enctype="multipart/form-data" action="/api/uploadfile" method="post">
    <input type="file" name="myFile">Upload a file
    <input type="submit" value="upload">
</form>

<div id="inputDialogFile" class="modal">
    <div class="modal-content">
        <h2>Enter file options</h2>
        <input type="text" id="filenameInput" placeholder="Enter filename">
        <input type="text" id="contentInput" placeholder="Enter content">
        <button id="confirmInputButton1">OK</button>
    </div>
</div>

<div id="inputDialogDir" class="modal">
    <div class="modal-content">
        <h2>Enter directory options</h2>
        <input type="text" id="dirnameInput" placeholder="Enter dirname">
        <button id="confirmInputButton2">OK</button>
    </div>
</div>

<table>
    <thead>
    <tr>
        <th>Имя</th>
        <th>Тип</th>
        <th>Размер</th>
        <th>Изменен</th>
    </tr>
    </thead>
    <tbody>
    {{range .}}
    <tr>
        <td><a href="{{if .IsDirectory}}/dir/{{else}}/file/{{end}}{{.Name}}">{{if .IsDirectory}}{{.Name}}/{{else}}{{.Name}}{{end}}</a></td>
        <td>{{if .IsDirectory}}d{{else}}f{{end}}</td>
        <td>{{if .IsDirectory}}-{{else}}{{.Size}}{{end}}</td>
        <td>{{.ModTime}}</td>
    </tr>
    {{end}}
    </tbody>
</table>
<script>
    // document.getElementById("uploadForm").addEventListener("submit", function(event) {
    //     // Prevent the default form submission behavior
    //
    //     // Perform any form submission processing here
    //     // For example, you can send the data to a server using fetch() or XMLHttpRequest
    //
    //     // After form processing, reload the page
    //     location.reload();
    // });

    const modalFile = document.getElementById("inputDialogFile");
    const openFileButton = document.getElementById("inputDialogBtn1");
    const confirmFileButton = document.getElementById("confirmInputButton1");

    const modalDir = document.getElementById("inputDialogDir");
    const openDirButton = document.getElementById("inputDialogBtn2");
    const confirmDirButton = document.getElementById("confirmInputButton2");

    function openFileDialog() {
        modalFile.style.display = "block";
    }

    function closeFileDialog() {
        modalFile.style.display = "none";
    }

    function openDirDialog() {
        modalDir.style.display = "block";
    }

    function closeDirDialog() {
        modalDir.style.display = "none";
    }

    openFileButton.addEventListener("click", openFileDialog);
    confirmFileButton.addEventListener("click", function () {closeFileDialog(); createNewFile()});

    openDirButton.addEventListener("click", openDirDialog);
    confirmDirButton.addEventListener("click", function () {closeDirDialog(); createNewDir()})

    const byteSize = str => new Blob([str]).size;

    function createNewFile() {
        const content = document.getElementById("contentInput").value;
        const name = document.getElementById("filenameInput").value;
        const size = byteSize(content);

        const data = {
            name: name,
            size: size,
            content: content,
            is_dir: false,
        };

        const requestOptions = {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        };

        const parentDir = window.location.pathname.split("/")[2]

        fetch("/api/createfile/" + parentDir, requestOptions)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok!");
                }
                return response.json();
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error("Error: ", error);
            });
    }

    function createNewDir() {
        const content = null;
        const name = document.getElementById("dirnameInput").value;

        const data = {
            name: name,
            size: 0,
            content: content,
            is_dir: true
        };

        const requestOptions = {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        };

        const parentDir = window.location.pathname.split("/")[2]

        fetch("/api/createfile/" + parentDir, requestOptions)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok!");
                }
                return response.json();
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error("Error: ", error);
            });
    }
</script>
</body>
</html>